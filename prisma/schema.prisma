generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Utilisateur {
  id                      String                  @id @default(cuid())
  authUserId              String?                 @unique
  email                   String                  @unique
  nom                     String?
  nbPersonnes             Int?
  budgetHebdomadaire      Int?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  jourSemaineBudget       Int?
  typeRepasBudget         String?
  // Stripe
  stripeCustomerId        String?                 @unique // null = jamais passé par Stripe
  stripeSubId             String?                 @unique // null = pas d'abo actif Stripe
  stripePriceId           String?                 // optionnel, pour savoir quel plan
  gardeManger             ArticleGardeManger[]
  listesEpicerie          ListeEpicerie[]
  preferences             Preferences?
  recettesFavorites       RecetteFavorite[]
  recettesFavoritesSearch RecetteFavoriteSearch[]
  recettesSemaine         RecetteSemaine[]
  repasSemaine            RepasSemaine[]
  subscriptions           Subscription[]          // Relation vers les abonnements
}

model Preferences {
  id                String      @id @default(cuid())
  utilisateurId     String      @unique
  vegetarien        Boolean     @default(false)
  sansGluten        Boolean     @default(false)
  allergenes        String?
  cuisinesFavorites String?
  alimentsPreferes  String?
  codePostal        String?
  // Premium (legacy - à migrer progressivement)
  isPremium         Boolean     @default(false)
  premiumUntil      DateTime?
  // Lifetime Premium
  isLifetimePremium Boolean     @default(false)
  premiumSince      DateTime?   // Date d'activation du premium (lifetime ou Stripe)
  utilisateur       Utilisateur @relation(fields: [utilisateurId], references: [id])
}

model Subscription {
  id                String      @id @default(cuid())
  utilisateurId     String
  stripeSubId       String      @unique // ID Stripe de l'abonnement
  stripePriceId     String?     // Plan Stripe
  status            String      // "active", "canceled", "past_due", etc.
  currentPeriodEnd  DateTime?   // Fin de la période actuelle
  cancelAtPeriodEnd Boolean     @default(false) // Annulation à la fin de la période
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  utilisateur       Utilisateur @relation(fields: [utilisateurId], references: [id])
  
  @@index([utilisateurId])
  @@index([stripeSubId])
  @@index([status])
}

model ArticleGardeManger {
  id            String      @id @default(cuid())
  utilisateurId String
  nom           String
  quantite      Float       @default(0)
  unite         String?
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])
}

model RecetteReference {
  id                String             @id @default(cuid())
  titre             String
  sourceUrl         String
  imageUrl          String?
  tempsPreparation  Int?
  tempsCuisson      Int?
  favoris           RecetteFavorite[]
  repas             Repas[]
  valeursNutritives ValeursNutritives?
}

model ValeursNutritives {
  id        String           @id @default(cuid())
  recetteId String           @unique
  calories  Int?
  proteines Float?
  glucides  Float?
  lipides   Float?
  recette   RecetteReference @relation(fields: [recetteId], references: [id])
}

model RepasSemaine {
  id            String      @id @default(cuid())
  utilisateurId String
  semaine       Int
  annee         Int
  repas         Repas[]
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])
}

model Repas {
  id             String            @id @default(cuid())
  repasSemaineId String
  jour           Int
  moment         String
  recetteId      String?
  recette        RecetteReference? @relation(fields: [recetteId], references: [id])
  repasSemaine   RepasSemaine      @relation(fields: [repasSemaineId], references: [id])
}

model ListeEpicerie {
  id            String       @id @default(cuid())
  utilisateurId String
  semaine       Int?
  annee         Int?
  coutTotal     Float?
  createdAt     DateTime     @default(now())
  lignes        LigneListe[]
  utilisateur   Utilisateur  @relation(fields: [utilisateurId], references: [id])
}

model LigneListe {
  id               String          @id @default(cuid())
  listeId          String
  itemId           String?
  recetteSemaineId String? // Lier l'ingrédient à une recette de la semaine
  nom              String
  quantite         Float
  unite            String?
  prixEstime       Float?
  item             Item?           @relation(fields: [itemId], references: [id])
  liste            ListeEpicerie   @relation(fields: [listeId], references: [id])
  recetteSemaine   RecetteSemaine? @relation(fields: [recetteSemaineId], references: [id])
}

model Item {
  id        String       @id @default(cuid())
  nom       String
  categorie String?
  lignes    LigneListe[]
}

model RecetteFavorite {
  id            String           @id @default(cuid())
  utilisateurId String
  recetteId     String
  createdAt     DateTime         @default(now())
  recette       RecetteReference @relation(fields: [recetteId], references: [id])
  utilisateur   Utilisateur      @relation(fields: [utilisateurId], references: [id])

  @@unique([utilisateurId, recetteId])
}

model WebSearchCache {
  id          Int      @id @default(autoincrement())
  query       String   @unique
  resultsJson String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SpoonacularRecipeCache {
  id            Int      @id @default(autoincrement())
  spoonacularId Int      @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  json          Json

  @@index([spoonacularId])
}

model SpoonacularSearchCache {
  id          Int      @id @default(autoincrement())
  cacheKey    String   @unique // Clé unique basée sur les paramètres de recherche
  maxPrice    Float // Budget maximum (pour recherche par plage)
  typeRepas   String? // Type de repas (pour recherche partielle)
  allergies   String // Allergies sérialisées (pour recherche partielle)
  maxResults  Int // Nombre de résultats demandés
  resultsJson Json // Résultats de la recherche (liste de recettes)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([maxPrice])
  @@index([typeRepas])
  @@index([cacheKey])
}

model RecetteSemaine {
  id            String       @id @default(cuid())
  utilisateurId String
  titre         String
  url           String
  image         String?
  snippet       String?
  source        String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  estimatedCost Float?
  servings      Int?
  spoonacularId Int?
  utilisateur   Utilisateur  @relation(fields: [utilisateurId], references: [id])
  ligneListes   LigneListe[]

  @@index([utilisateurId])
  @@index([spoonacularId])
}

model PrixIngredient {
  id        String   @id @default(cuid())
  nom       String   @unique
  prixMoyen Float
  categorie String?
  source    String   @default("flipp")
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([nom])
  @@index([categorie])
}

model RecetteFavoriteSearch {
  id            String      @id @default(cuid())
  utilisateurId String
  titre         String
  url           String
  image         String?
  snippet       String?
  source        String?
  estimatedCost Float?
  servings      Int?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])

  @@unique([utilisateurId, url])
  @@index([utilisateurId])
}
